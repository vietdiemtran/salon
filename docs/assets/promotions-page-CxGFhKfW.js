import{B as M,j as e,o as L,z as $,E as P,h as B,F as Y,G as X,H as G,r as F}from"./index-Co3jKZaL.js";import{u as K}from"./useMutation-BSFioODP.js";import{B as S}from"./button-BNCUvJzd.js";import{P as E,a as T,b as k,C as I,d as U,i as W}from"./popover-Co-wHFZU.js";import{D as J,b as Z,c as ee,d as te,e as ne,f as se}from"./dialog-DsEfTekn.js";import{z as x,u as ae,s as re,g as ie,F as le,a as y,b as f,c as v,d as D,e as C}from"./zod-DR_j3zP9.js";import{I as b}from"./input-DAU5vPOq.js";import{S as _,a as A,b as R,c as q,d as N}from"./select-CMLZ4ZLM.js";import{T as ce}from"./textarea-DI5-A45c.js";import{C as V}from"./calendar-pbP-nKA2.js";import{n as oe,e as de,f as w}from"./format-Bki_VTC_.js";import{S as ue}from"./search-CISIHeZP.js";import{B as he}from"./badge-DtNea2y1.js";import{C as me,b as ge,c as xe,a as je,e as pe}from"./card-5fN4BC23.js";import{P as ye}from"./pencil-D5-fFQMG.js";import{T as fe}from"./trash-2-Cbbl3EUH.js";import{D as ve}from"./data-pagination-BpWcArmC.js";import{u as De,a as Ce}from"./use-sync-url-states-W091DZhx.js";import{u as Ne}from"./useQuery-D61Jsyd7.js";import{P as Se}from"./plus-CAZAkEn4.js";import"./chevron-right-BVZHUiVw.js";import"./chevron-left-DiLf67sb.js";import"./Combination-Bb8ckWgm.js";import"./index-C7ei8kKs.js";import"./index-m_3Aq4-g.js";import"./label-BQaUV1Av.js";import"./index-BV-DTqk3.js";import"./isNumber-5m_zYJtK.js";function be(t,a,r){const[o,c]=oe(r==null?void 0:r.in,t,a),d=O(o,c),h=Math.abs(de(o,c));o.setDate(o.getDate()-d*h);const l=+(O(o,c)===-d),u=d*(h-l);return u===0?0:u}function O(t,a){const r=t.getFullYear()-a.getFullYear()||t.getMonth()-a.getMonth()||t.getDate()-a.getDate()||t.getHours()-a.getHours()||t.getMinutes()-a.getMinutes()||t.getSeconds()-a.getSeconds()||t.getMilliseconds()-a.getMilliseconds();return r<0?-1:r>0?1:r}const we=async t=>{const a={...t,...t.startDate&&{startDate:new Date(t.startDate).toISOString()},...t.endDate&&{endDate:new Date(t.endDate).toISOString()}};return(await M.get("/admin/promotions",{params:a})).data.result},Pe=async t=>(await M.post("/admin/promotions",t)).data.result,Ee=async({id:t,data:a})=>(await M.put(`/admin/promotions/${t}`,a)).data.result,Te=async t=>{await M.delete(`/admin/promotions/${t}`)};var j=(t=>(t[t.ACTIVE=1]="ACTIVE",t[t.INACTIVE=2]="INACTIVE",t[t.EXPIRED=3]="EXPIRED",t))(j||{}),m=(t=>(t[t.PERCENT=1]="PERCENT",t[t.CASH=2]="CASH",t))(m||{});const ke=x.nativeEnum(j,{required_error:"Vui lòng chọn trạng thái",invalid_type_error:"Trạng thái không hợp lệ"}),Ie=x.nativeEnum(m,{required_error:"Vui lòng chọn loại khuyến mãi",invalid_type_error:"Loại khuyến mãi không hợp lệ"}),Ve=x.object({discountCode:x.string({required_error:"Vui lòng nhập mã khuyến mãi"}).min(1,"Mã khuyến mãi không được để trống"),description:x.string({required_error:"Vui lòng nhập mô tả"}).min(1,"Mô tả không được để trống"),discountType:Ie,discountRate:x.number({required_error:"Vui lòng nhập tỷ lệ giảm giá",invalid_type_error:"Tỷ lệ giảm giá không hợp lệ"}).min(0,"Tỷ lệ giảm giá phải lớn hơn hoặc bằng 0"),discountQuantity:x.number({required_error:"Vui lòng nhập số lượng khuyến mãi",invalid_type_error:"Số lượng khuyến mãi không hợp lệ"}).int("Số lượng phải là số nguyên").min(0,"Số lượng khuyến mãi phải lớn hơn hoặc bằng 0"),startDate:x.string({required_error:"Vui lòng chọn ngày bắt đầu"}).datetime({message:"Ngày bắt đầu không đúng định dạng"}),endDate:x.string({required_error:"Vui lòng chọn ngày kết thúc"}).datetime({message:"Ngày kết thúc không đúng định dạng"}),status:ke,discountMax:x.number({required_error:"Vui lòng nhập mức giảm tối đa",invalid_type_error:"Mức giảm tối đa không hợp lệ"}).min(0,"Mức giảm tối đa phải lớn hơn hoặc bằng 0")}).refine(t=>new Date(t.endDate)>new Date(t.startDate),{message:"Ngày kết thúc phải sau ngày bắt đầu",path:["endDate"]});function z({isOpen:t,isSubmitting:a,title:r,description:o,defaultValues:c,onClose:d,onSubmit:h}){const l=ae({resolver:re(Ve),defaultValues:{discountCode:"",description:"",discountType:m.PERCENT,discountRate:0,discountQuantity:1,startDate:new Date().toISOString(),endDate:new Date().toISOString(),status:j.ACTIVE,discountMax:0,...c}}),u=n=>{h(n)},p=ie({control:l.control,name:"discountType"});return e.jsx(J,{open:t,onOpenChange:d,children:e.jsxs(Z,{className:"h-[calc(100vh-200px)] px-0 sm:max-w-[550px]",children:[e.jsxs(ee,{className:"px-6",children:[e.jsx(te,{children:r}),e.jsx(ne,{children:o})]}),e.jsx(le,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(u),className:"space-y-4 overflow-y-auto p-6 pb-12",children:[e.jsx(y,{control:l.control,name:"discountCode",render:({field:n})=>e.jsxs(f,{children:[e.jsx(v,{children:"Mã khuyến mãi"}),e.jsx(D,{children:e.jsx(b,{placeholder:"Nhập mã khuyến mãi",...n})}),e.jsx(C,{})]})}),e.jsx(y,{control:l.control,name:"description",render:({field:n})=>e.jsxs(f,{children:[e.jsx(v,{children:"Mô tả"}),e.jsx(D,{children:e.jsx(ce,{placeholder:"Nhập mô tả khuyến mãi",...n})}),e.jsx(C,{})]})}),e.jsx(y,{control:l.control,name:"discountType",render:({field:n})=>e.jsxs(f,{children:[e.jsx(v,{children:"Loại giảm giá"}),e.jsxs(_,{onValueChange:i=>n.onChange(parseInt(i)),value:`${n.value}`,children:[e.jsx(D,{children:e.jsx(A,{children:e.jsx(R,{placeholder:"Chọn loại giảm giá"})})}),e.jsxs(q,{children:[e.jsx(N,{value:`${m.PERCENT}`,children:"Phần trăm"}),e.jsx(N,{value:`${m.CASH}`,children:"Số tiền cố định"})]})]}),e.jsx(C,{})]})}),e.jsx(y,{control:l.control,name:"discountRate",render:({field:n})=>e.jsxs(f,{children:[e.jsx(v,{children:p===m.PERCENT?"Phần trăm giảm giá (%)":"Số tiền giảm (VNĐ)"}),e.jsx(D,{children:e.jsx(b,{type:"number",min:0,max:p===m.PERCENT?100:void 0,step:p===m.PERCENT?.01:1e3,...n,onChange:i=>{p===m.CASH&&l.setValue("discountMax",parseFloat(i.target.value)),n.onChange(parseFloat(i.target.value))}})}),e.jsx(C,{})]})}),e.jsx(y,{control:l.control,name:"discountQuantity",render:({field:n})=>e.jsxs(f,{children:[e.jsx(v,{children:"Số lần sử dụng"}),e.jsx(D,{children:e.jsx(b,{type:"number",min:1,...n,onChange:i=>n.onChange(parseInt(i.target.value))})}),e.jsx(C,{})]})}),e.jsx(y,{control:l.control,name:"discountMax",render:({field:n})=>e.jsxs(f,{children:[e.jsx(v,{children:"Giảm tối đa (VNĐ)"}),e.jsx(D,{children:e.jsx(b,{type:"number",min:0,disabled:p===m.CASH,...n,onChange:i=>n.onChange(parseFloat(i.target.value))})}),e.jsx(C,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(y,{control:l.control,name:"startDate",render:({field:n})=>e.jsxs(f,{className:"flex flex-col",children:[e.jsx(v,{children:"Ngày bắt đầu"}),e.jsxs(E,{children:[e.jsx(T,{asChild:!0,children:e.jsx(D,{children:e.jsxs(S,{variant:"outline",className:`w-full pl-3 text-left font-normal ${n.value?"":"text-muted-foreground"}`,children:[n.value?w(new Date(n.value),"dd/MM/yyyy"):e.jsx("span",{children:"Chọn ngày"}),e.jsx(V,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(k,{className:"w-auto p-0",align:"start",children:e.jsx(I,{mode:"single",selected:n.value?new Date(n.value):void 0,onSelect:i=>n.onChange(i==null?void 0:i.toISOString()),initialFocus:!0})})]}),e.jsx(C,{})]})}),e.jsx(y,{control:l.control,name:"endDate",render:({field:n})=>e.jsxs(f,{className:"flex flex-col",children:[e.jsx(v,{children:"Ngày kết thúc"}),e.jsxs(E,{children:[e.jsx(T,{asChild:!0,children:e.jsx(D,{children:e.jsxs(S,{variant:"outline",className:`w-full pl-3 text-left font-normal ${n.value?"":"text-muted-foreground"}`,children:[n.value?w(new Date(n.value),"dd/MM/yyyy"):e.jsx("span",{children:"Chọn ngày"}),e.jsx(V,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(k,{className:"w-auto p-0",align:"start",children:e.jsx(I,{mode:"single",selected:n.value?new Date(n.value):void 0,onSelect:i=>n.onChange(i==null?void 0:i.toISOString()),initialFocus:!0,disabled:i=>{const g=l.watch("startDate");return g?i<new Date(g):!1}})})]}),e.jsx(C,{})]})})]}),e.jsx(y,{control:l.control,name:"status",render:({field:n})=>{var i;return e.jsxs(f,{children:[e.jsx(v,{children:"Trạng thái"}),e.jsxs(_,{onValueChange:g=>n.onChange(parseInt(g)),value:(i=n.value)==null?void 0:i.toString(),children:[e.jsx(D,{children:e.jsx(A,{children:e.jsx(R,{placeholder:"Chọn trạng thái"})})}),e.jsxs(q,{children:[e.jsx(N,{value:j.INACTIVE.toString(),children:"Không hoạt động"}),e.jsx(N,{value:j.ACTIVE.toString(),children:"Đang hoạt động"}),e.jsx(N,{value:j.EXPIRED.toString(),children:"Đã hết hạn"})]})]}),e.jsx(C,{})]})}}),e.jsxs(se,{className:"absolute inset-x-6 bottom-6",children:[e.jsx(S,{type:"button",variant:"outline",onClick:d,children:"Hủy"}),e.jsx(S,{type:"submit",disabled:a,children:a?"Đang xử lý...":"Lưu"})]})]})})]})})}function Me({isOpen:t,onClose:a}){const{toast:r}=L(),o=K({mutationFn:Pe,onSuccess:()=>{$.invalidateQueries({queryKey:["/api/promotions"]}),a(),r({title:"Thành công",description:"Chương trình khuyến mãi đã được tạo."})},onError:d=>{r({title:"Lỗi",description:`Không thể tạo chương trình khuyến mãi: ${d.message}`,variant:"destructive"})}}),c=d=>{o.mutate(d)};return e.jsx(z,{isOpen:t,onClose:a,onSubmit:c,isSubmitting:o.isPending,title:"Thêm khuyến mãi mới",description:"Thêm chương trình khuyến mãi mới cho salon"})}function Fe({filters:t,setFilters:a}){return e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 transform text-gray-400"}),e.jsx(b,{placeholder:"Tìm kiếm khuyến mãi...",className:"pl-9",value:t.name,onChange:r=>a.name(r.target.value)})]}),e.jsxs(_,{value:t.status,onValueChange:a.status,children:[e.jsx(A,{className:"w-full md:w-[200px]",children:e.jsx(R,{placeholder:"Trạng thái"})}),e.jsxs(q,{children:[e.jsx(N,{value:P,children:"Tất cả"}),e.jsx(N,{value:`${j.ACTIVE}`,children:"Đang hoạt động"}),e.jsx(N,{value:`${j.INACTIVE}`,children:"Không hoạt động"}),e.jsx(N,{value:`${j.EXPIRED}`,children:"Hết hạn"})]})]}),e.jsxs(E,{children:[e.jsx(T,{asChild:!0,children:e.jsxs(S,{variant:"outline",className:"w-full justify-start text-left font-normal md:w-[200px]",children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),t.startDate?w(t.startDate,"PPP"):e.jsx("span",{children:"Ngày bắt đầu"})]})}),e.jsx(k,{className:"w-auto p-0",align:"start",children:e.jsx(I,{mode:"single",selected:t.startDate||void 0,onSelect:r=>a.startDate(r||null),disabled:r=>t.endDate?U(r,t.endDate):!1,initialFocus:!0})})]}),e.jsxs(E,{children:[e.jsx(T,{asChild:!0,children:e.jsxs(S,{variant:"outline",className:"w-full justify-start text-left font-normal md:w-[200px]",children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),t.endDate?w(t.endDate,"PPP"):e.jsx("span",{children:"Ngày kết thúc"})]})}),e.jsx(k,{className:"w-auto p-0",align:"start",children:e.jsx(I,{mode:"single",selected:t.endDate||void 0,onSelect:r=>a.endDate(r||null),disabled:r=>t.startDate?W(r,t.startDate):!1,initialFocus:!0})})]})]})}const H=t=>t!==void 0?`${t.toLocaleString("en-US")}₫`:"0₫";function Q(t){return w(t,"yyyy/MM/dd")}function _e({promotions:t,isLoading:a,onEdit:r}){const{toast:o}=L(),c=B(),d=n=>{const i=new Date,g=new Date(n.startDate),s=new Date(n.endDate);return n.status===j.ACTIVE&&i>=g&&i<=s},h=n=>n.discountType===m.PERCENT?`${n.discountRate}%`:H(n.discountRate),l=n=>{const i=new Date,g=new Date(n.endDate),s=be(g,i);return s>0?s:0},u=K({mutationFn:Te,onSuccess:()=>{$.invalidateQueries({queryKey:["/api/promotions"]}),o({title:"Thành công",description:"Chương trình khuyến mãi đã được xóa."})},onError:n=>{o({title:"Lỗi",description:`Không thể xóa chương trình khuyến mãi: ${n.message}`,variant:"destructive"})},onSettled:()=>{c(Y())}}),p=n=>{c(G()),u.mutate(n)};return e.jsxs(e.Fragment,{children:[a?e.jsx(X,{}):e.jsx("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3",children:t.map(n=>e.jsxs(me,{className:`overflow-hidden border-l-4 ${d(n)?"border-l-green-500":"border-l-gray-300"}`,children:[e.jsxs(ge,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx(xe,{className:"text-lg",children:n.discountCode||"Không có mã"}),e.jsx(he,{variant:d(n)?"default":"secondary",children:d(n)?"Đang hoạt động":"Không hoạt động"})]}),e.jsx("p",{className:"line-clamp-2 text-sm text-gray-500",children:n.description||"Không có mô tả"})]}),e.jsx(je,{className:"pb-2",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Giảm giá"}),e.jsx("p",{className:"font-medium text-primary",children:h(n)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Số lần sử dụng"}),e.jsx("p",{className:"font-medium",children:n.discountQuantity})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Giảm tối đa"}),e.jsx("p",{className:"font-medium",children:H(n.discountMax)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Còn lại"}),e.jsxs("p",{className:"font-medium",children:[l(n)," ngày"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Ngày bắt đầu"}),e.jsx("p",{className:"font-medium",children:Q(new Date(n.startDate))})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Ngày kết thúc"}),e.jsx("p",{className:"font-medium",children:Q(new Date(n.endDate))})]})]})}),e.jsxs(pe,{className:"flex justify-end gap-2 pt-2",children:[e.jsxs(S,{variant:"outline",size:"sm",onClick:()=>r(n),children:[e.jsx(ye,{className:"mr-1 h-4 w-4"}),"Sửa"]}),e.jsxs(S,{variant:"destructive",size:"sm",onClick:()=>{confirm("Bạn có chắc chắn muốn xóa chương trình khuyến mãi này?")&&p(n.id)},children:[e.jsx(fe,{className:"mr-1 h-4 w-4"}),"Xóa"]})]})]},n.id))}),t.length===0&&!a&&e.jsx("div",{className:"col-span-1 flex h-40 items-center justify-center rounded-lg bg-gray-50 md:col-span-2 lg:col-span-3",children:e.jsx("p",{className:"text-gray-500",children:"Chưa có chương trình khuyến mãi"})})]})}function Ae({promotion:t,isOpen:a,onClose:r}){const{toast:o}=L(),[c,d]=F.useState(!1),h=K({mutationFn:Ee,onSuccess:()=>{$.invalidateQueries({queryKey:["/api/promotions"]}),o({title:"Thành công",description:"Chương trình khuyến mãi đã được cập nhật."}),r()},onError:u=>{o({title:"Lỗi",description:`Không thể cập nhật chương trình khuyến mãi: ${u.message}`,variant:"destructive"})}}),l=async u=>{d(!0),h.mutateAsync({id:t.id,data:u})};return e.jsx(z,{defaultValues:{discountCode:t.discountCode,discountRate:t.discountRate,discountType:t.discountType,startDate:t.startDate,endDate:t.endDate,status:t.status,description:t.description,discountQuantity:t.discountQuantity,discountMax:t.discountMax},isOpen:a,isSubmitting:c,title:"Cập nhật khuyến mãi",description:"Cập nhật thông tin chương trình khuyến mãi",onClose:r,onSubmit:l})}function ut(){const[t,a]=F.useState(!1),[r,o]=F.useState(null),{values:c,setters:d}=De({name:{defaultValue:"",parse:s=>s,stringify:s=>s},status:{defaultValue:P,parse:s=>s,stringify:s=>s?String(s):P},startDate:{defaultValue:null,parse:s=>s?new Date(s):null,stringify:s=>s?s.toISOString():""},endDate:{defaultValue:null,parse:s=>s?new Date(s):null,stringify:s=>s?s.toISOString():""},page:{defaultValue:1,parse:s=>Number(s)||1,stringify:s=>String(s)},size:{defaultValue:8,parse:s=>Number(s)||8,stringify:s=>String(s)}}),h=Ce({name:c.name,status:c.status===P?"":c.status,startDate:c.startDate,endDate:c.endDate,page:c.page-1,size:c.size}),{data:{data:l=[],totalPage:u=1,currentPage:p=1}={},isLoading:n}=Ne({queryKey:["/api/promotions",h],queryFn:()=>we(h)}),i=s=>{o(s)},g=s=>{d.page(s)};return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-heading text-2xl font-bold text-neutral-900",children:"Khuyến mãi"}),e.jsx("p",{className:"text-neutral-600",children:"Quản lý các chương trình khuyến mãi và giảm giá"})]}),e.jsxs(S,{onClick:()=>a(!0),children:[e.jsx(Se,{className:"mr-2 h-4 w-4"}),"Thêm dịch vụ"]})]}),e.jsx("div",{className:"mb-6",children:e.jsx(Fe,{filters:c,setFilters:d})}),e.jsx(_e,{promotions:l,isLoading:n,onEdit:i}),e.jsx(ve,{currentPage:p,totalPage:u,onPageChange:g}),t&&e.jsx(Me,{isOpen:t,onClose:()=>a(!1)}),r&&e.jsx(Ae,{promotion:r,isOpen:!!r,onClose:()=>o(null)})]})}export{ut as default};
