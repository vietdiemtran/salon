import{r as S,g as U,j as e,z as D,A as C}from"./index-Dj3cS6za.js";import{B as M}from"./badge-DWVlFQai.js";import{B as h}from"./button-Crtod_yx.js";import{P as F,a as K,b as V,C as I}from"./popover-DWJz2dMU.js";import{C as X,b as J,c as W,a as Y,e as Z}from"./card-C8qa4OaK.js";import{C as $}from"./checkbox-BgBSMKdn.js";import{D as ee,b as se,c as te,d as ne,e as ae,f as re}from"./dialog-Bn5CZ0A2.js";import{u as ie,s as ce,F as le,a as r,b as i,c,d as o,e as d,L as w,z as u}from"./zod-4yZnVHA1.js";import{I as b}from"./input-CZim18_A.js";import{R as oe,a as L}from"./radio-group-a721QW4_.js";import{u as P,T as de}from"./textarea-BFAuNgGI.js";import{a as me,s as he,t as k,i as E,c as A,b as ue,j as xe,d as pe}from"./index-DTV90kgF.js";import{u as q}from"./useQuery-Q6h1jA1k.js";import{P as ge}from"./plus-gjNRdYAo.js";import{P as je}from"./pencil-C9t2SmZI.js";import{T as ye}from"./trash-2-Dn9sZtSU.js";import{C as R}from"./calendar-B3ImGPjP.js";import{f as z}from"./format-C_m1koB7.js";import"./chevron-left-BV-eJxQL.js";import"./chevron-right-HV8dK0o4.js";import"./Combination-27LuzUOQ.js";import"./index-CF79JPbI.js";import"./index-BGWUGcaw.js";import"./index-DvGPzrVe.js";import"./check-sEMdCc3q.js";import"./index-Cq9-3w0A.js";import"./circle-CXPwp_EJ.js";const ve=me("promotions",{id:he("id").primaryKey(),name:k("name").notNull(),description:k("description"),discountPercent:E("discount_percent"),discountAmount:E("discount_amount"),code:k("code"),startDate:A("start_date").notNull(),endDate:A("end_date").notNull(),active:ue("active").default(!0),serviceIds:xe("service_ids").$type()}),Ne=pe(ve).omit({id:!0}),fe=Ne.extend({discountType:u.enum(["percent","amount"]),discountValue:u.coerce.number().min(1,{message:"Giá trị giảm giá phải lớn hơn 0"}),startDate:u.date(),endDate:u.date(),serviceIds:u.array(u.number()).optional()});function Xe(){const[B,x]=S.useState(!1),[p,j]=S.useState(null),{toast:m}=U(),{data:T=[],isLoading:Q}=q({queryKey:["/api/promotions"]}),{data:y=[]}=q({queryKey:["/api/services"]}),v=P({mutationFn:async s=>(await D("POST","/api/promotions",s)).json(),onSuccess:()=>{C.invalidateQueries({queryKey:["/api/promotions"]}),x(!1),m({title:"Thành công",description:"Chương trình khuyến mãi đã được tạo."})},onError:s=>{m({title:"Lỗi",description:`Không thể tạo chương trình khuyến mãi: ${s.message}`,variant:"destructive"})}}),N=P({mutationFn:async s=>(await D("PUT",`/api/promotions/${s.id}`,s.promotion)).json(),onSuccess:()=>{C.invalidateQueries({queryKey:["/api/promotions"]}),j(null),m({title:"Thành công",description:"Chương trình khuyến mãi đã được cập nhật."})},onError:s=>{m({title:"Lỗi",description:`Không thể cập nhật chương trình khuyến mãi: ${s.message}`,variant:"destructive"})}}),_=P({mutationFn:async s=>{await D("DELETE",`/api/promotions/${s}`)},onSuccess:()=>{C.invalidateQueries({queryKey:["/api/promotions"]}),m({title:"Thành công",description:"Chương trình khuyến mãi đã được xóa."})},onError:s=>{m({title:"Lỗi",description:`Không thể xóa chương trình khuyến mãi: ${s.message}`,variant:"destructive"})}}),n=ie({resolver:ce(fe),defaultValues:{name:"",description:"",discountType:"percent",discountValue:0,code:"",startDate:new Date,endDate:new Date(new Date().setMonth(new Date().getMonth()+1)),active:!0,serviceIds:[]}}),G=s=>{j(s),n.reset({name:s.name,description:s.description||"",discountType:s.discountPercent?"percent":"amount",discountValue:s.discountPercent||(s.discountAmount?s.discountAmount/100:0),code:s.code||"",startDate:new Date(s.startDate),endDate:new Date(s.endDate),active:s.active,serviceIds:s.serviceIds||[]}),x(!0)},O=s=>{const{discountType:t,discountValue:a,...l}=s,g={...l,discountPercent:t==="percent"?Math.min(a,100):null,discountAmount:t==="amount"?Math.round(a*100):null};p?N.mutate({id:p.id,promotion:g}):v.mutate(g),x(!1)},f=s=>{const t=new Date,a=new Date(s.startDate),l=new Date(s.endDate);return s.active&&t>=a&&t<=l},H=s=>s.discountPercent?`${s.discountPercent}%`:s.discountAmount?`${(s.discountAmount/100).toLocaleString("vi-VN")}₫`:"Không xác định";return e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-heading text-2xl font-bold text-neutral-900",children:"Khuyến mãi"}),e.jsx("p",{className:"text-neutral-600",children:"Quản lý các chương trình khuyến mãi và giảm giá"})]}),e.jsxs(h,{onClick:()=>{n.reset({name:"",description:"",discountType:"percent",discountValue:0,code:"",startDate:new Date,endDate:new Date(new Date().setMonth(new Date().getMonth()+1)),active:!0,serviceIds:[]}),j(null),x(!0)},children:[e.jsx(ge,{className:"mr-2 h-4 w-4"}),"Thêm khuyến mãi mới"]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3",children:[T.map(s=>e.jsxs(X,{className:`overflow-hidden border-l-4 ${f(s)?"border-l-green-500":"border-l-gray-300"}`,children:[e.jsxs(J,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx(W,{className:"text-lg",children:s.name}),e.jsx(M,{variant:f(s)?"default":"secondary",children:f(s)?"Đang hoạt động":"Không hoạt động"})]}),e.jsx("p",{className:"line-clamp-2 text-sm text-gray-500",children:s.description||"Không có mô tả"})]}),e.jsxs(Y,{className:"pb-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Giảm giá"}),e.jsx("p",{className:"font-medium text-primary",children:H(s)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Mã giảm giá"}),e.jsx("p",{className:"font-medium",children:s.code||"Không có mã"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Ngày bắt đầu"}),e.jsx("p",{className:"font-medium",children:new Date(s.startDate).toLocaleDateString("vi-VN")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:"Ngày kết thúc"}),e.jsx("p",{className:"font-medium",children:new Date(s.endDate).toLocaleDateString("vi-VN")})]})]}),s.serviceIds&&s.serviceIds.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Áp dụng cho dịch vụ:"}),e.jsx("div",{className:"mt-1 flex flex-wrap gap-1",children:s.serviceIds.map(t=>{const a=y.find(l=>l.id===t);return a?e.jsx(M,{variant:"outline",className:"text-xs",children:a.name},t):null})})]})]}),e.jsxs(Z,{className:"flex justify-end gap-2 pt-2",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>G(s),children:[e.jsx(je,{className:"mr-1 h-4 w-4"}),"Sửa"]}),e.jsxs(h,{variant:"destructive",size:"sm",onClick:()=>{confirm("Bạn có chắc chắn muốn xóa chương trình khuyến mãi này?")&&_.mutate(s.id)},children:[e.jsx(ye,{className:"mr-1 h-4 w-4"}),"Xóa"]})]})]},s.id)),T.length===0&&!Q&&e.jsx("div",{className:"col-span-1 flex h-40 items-center justify-center rounded-lg bg-gray-50 md:col-span-2 lg:col-span-3",children:e.jsx("p",{className:"text-gray-500",children:"Chưa có chương trình khuyến mãi"})})]}),e.jsx(ee,{open:B,onOpenChange:x,children:e.jsxs(se,{className:"h-[calc(100vh-200px)] px-0 sm:max-w-[550px]",children:[e.jsxs(te,{className:"px-6",children:[e.jsx(ne,{children:p?"Chỉnh sửa khuyến mãi":"Thêm khuyến mãi mới"}),e.jsx(ae,{children:p?"Cập nhật thông tin chương trình khuyến mãi":"Thêm chương trình khuyến mãi mới cho salon"})]}),e.jsx(le,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(O),className:"space-y-4 overflow-y-auto px-6 py-12",children:[e.jsx(r,{control:n.control,name:"name",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Tên chương trình"}),e.jsx(o,{children:e.jsx(b,{placeholder:"Nhập tên chương trình khuyến mãi",...s})}),e.jsx(d,{})]})}),e.jsx(r,{control:n.control,name:"description",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Mô tả"}),e.jsx(o,{children:e.jsx(de,{placeholder:"Mô tả chi tiết về chương trình",className:"resize-none",...s})}),e.jsx(d,{})]})}),e.jsx(r,{control:n.control,name:"discountType",render:({field:s})=>e.jsxs(i,{className:"space-y-3",children:[e.jsx(c,{children:"Loại giảm giá"}),e.jsx(o,{children:e.jsxs(oe,{onValueChange:s.onChange,defaultValue:s.value,className:"flex flex-col space-y-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{value:"percent",id:"percent"}),e.jsx(w,{htmlFor:"percent",children:"Phần trăm (%)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{value:"amount",id:"amount"}),e.jsx(w,{htmlFor:"amount",children:"Số tiền cố định (VNĐ)"})]})]})}),e.jsx(d,{})]})}),e.jsx(r,{control:n.control,name:"discountValue",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:n.watch("discountType")==="percent"?"Phần trăm giảm giá (%)":"Số tiền giảm (VNĐ)"}),e.jsx(o,{children:e.jsx(b,{type:"number",min:"0",max:n.watch("discountType")==="percent"?"100":void 0,...s})}),e.jsx(d,{})]})}),e.jsx(r,{control:n.control,name:"code",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Mã giảm giá (không bắt buộc)"}),e.jsx(o,{children:e.jsx(b,{placeholder:"SUMMER2023",...s})}),e.jsx(d,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(r,{control:n.control,name:"startDate",render:({field:s})=>e.jsxs(i,{className:"flex flex-col",children:[e.jsx(c,{children:"Ngày bắt đầu"}),e.jsxs(F,{children:[e.jsx(K,{asChild:!0,children:e.jsx(o,{children:e.jsxs(h,{variant:"outline",className:`w-full pl-3 text-left font-normal ${s.value?"":"text-muted-foreground"}`,children:[s.value?z(s.value,"dd/MM/yyyy"):e.jsx("span",{children:"Chọn ngày"}),e.jsx(R,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(V,{className:"w-auto p-0",align:"start",children:e.jsx(I,{mode:"single",selected:s.value,onSelect:s.onChange,initialFocus:!0})})]}),e.jsx(d,{})]})}),e.jsx(r,{control:n.control,name:"endDate",render:({field:s})=>e.jsxs(i,{className:"flex flex-col",children:[e.jsx(c,{children:"Ngày kết thúc"}),e.jsxs(F,{children:[e.jsx(K,{asChild:!0,children:e.jsx(o,{children:e.jsxs(h,{variant:"outline",className:`w-full pl-3 text-left font-normal ${s.value?"":"text-muted-foreground"}`,children:[s.value?z(s.value,"dd/MM/yyyy"):e.jsx("span",{children:"Chọn ngày"}),e.jsx(R,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(V,{className:"w-auto p-0",align:"start",children:e.jsx(I,{mode:"single",selected:s.value,onSelect:s.onChange,initialFocus:!0,disabled:t=>t<n.watch("startDate")})})]}),e.jsx(d,{})]})})]}),e.jsx(r,{control:n.control,name:"serviceIds",render:({field:s})=>e.jsxs(i,{children:[e.jsx(c,{children:"Áp dụng cho dịch vụ"}),e.jsxs("div",{className:"h-[200px] overflow-y-auto rounded-md border p-2",children:[y.map(t=>e.jsxs("div",{className:"flex items-center space-x-2 py-1",children:[e.jsx($,{id:`service-${t.id}`,checked:(s.value||[]).includes(t.id),onCheckedChange:a=>{const l=s.value||[];a?s.onChange([...l,t.id]):s.onChange(l.filter(g=>g!==t.id))}}),e.jsxs(w,{htmlFor:`service-${t.id}`,className:"flex-1 cursor-pointer",children:[e.jsx("span",{className:"font-medium",children:t.name}),e.jsxs("span",{className:"ml-2 text-sm text-gray-500",children:["(",(t.price/100).toLocaleString("vi-VN"),"₫)"]})]})]},t.id)),y.length===0&&e.jsx("p",{className:"py-4 text-center text-gray-500",children:"Không có dịch vụ nào"})]}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Để trống nếu áp dụng cho tất cả dịch vụ"}),e.jsx(d,{})]})}),e.jsx(r,{control:n.control,name:"active",render:({field:s})=>e.jsxs(i,{className:"flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4",children:[e.jsx(o,{children:e.jsx($,{checked:s.value,onCheckedChange:s.onChange})}),e.jsxs("div",{className:"space-y-1 leading-none",children:[e.jsx(c,{children:"Kích hoạt khuyến mãi"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Khuyến mãi đang hoạt động sẽ được áp dụng cho khách hàng"})]})]})}),e.jsx(re,{className:"absolute inset-x-6 bottom-6",children:e.jsx(h,{type:"submit",disabled:v.isPending||N.isPending,children:v.isPending||N.isPending?"Đang xử lý...":p?"Cập nhật":"Thêm khuyến mãi"})})]})})]})})]})}export{Xe as default};
